import{e as l,g as c,s,a as p,u as n,c as v,U as g,T,b as A,W as k,d as C}from"./assets/supabaseClient-Bz3XHaaj.js";const M=6e4,O=1e4,R=1e3,b=6e4,U=12e4,N=3e5;let m=!1,_=!0;async function E(t){try{const{data:e,error:r}=await s.from("profiles").select("user_id").eq("user_id",t).single();return r?(console.error("Error getting profile user_id:",r),null):(e==null?void 0:e.user_id)||null}catch(e){return console.error("Error getting profile user_id:",e),null}}async function d(){try{const t=await chrome.windows.getAll({populate:!0});for(const r of t)if(r.focused&&r.tabs){for(const o of r.tabs)if(o.active&&o.url)return o.url}const e=await chrome.tabs.query({active:!0});return e.length>0&&e[0].url?e[0].url:null}catch{return null}}async function f(t){const e=await c();if(e.currentDomain===t)return;if(e.currentDomain&&e.userId){const o=v(e.currentDomain);o==="productive"&&e.consecutiveProductiveMs>0?e.consecutiveProductiveMs>=M&&await P(e.currentDomain,e.consecutiveProductiveMs,e.userId):o==="unproductive"&&e.unproductiveMsBuffer>0&&await S(e.unproductiveMsBuffer,e.userId)}const r=v(t);await n({currentDomain:t,lastTick:Date.now(),consecutiveProductiveMs:r==="productive"?0:e.consecutiveProductiveMs,unproductiveMsBuffer:r==="unproductive"?0:e.unproductiveMsBuffer})}async function P(t,e,r){try{const o=Math.floor(e/1e3);await s.from("productive_triggers").insert({user_id:r,domain:t,duration_seconds:o}),console.log(`Recorded productive trigger: ${t} for ${o}s`)}catch(o){console.error("Error recording productive trigger:",o)}}async function S(t,e){try{const r=Math.floor(t/1e3);await s.from("leaderboard_scores").insert({user_id:e,score:r}),console.log(`Recorded unproductive time: ${r}s`)}catch(r){console.error("Error recording unproductive time:",r)}}async function B(){try{const t=await c(),e=Date.now();if(t.lastCallTriggerTime>0&&e-t.lastCallTriggerTime<N){console.log("AI call cooldown active, skipping call");return}const r=g.startsWith("+")?g:`+1${g}`,o=btoa(`${T}:${A}`),a=`https://api.twilio.com/2010-04-01/Accounts/${T}/Calls.json`,i=k,u=new URLSearchParams;u.append("From",C),u.append("To",r),u.append("Url",i),u.append("Method","POST");const w=await fetch(a,{method:"POST",headers:{Authorization:`Basic ${o}`,"Content-Type":"application/x-www-form-urlencoded"},body:u.toString()});if(!w.ok){const L=await w.text();console.error("Error initiating Twilio call:",L);return}const y=await w.json();console.log("AI agent call initiated:",y.sid),await n({lastCallTriggerTime:e})}catch(t){console.error("Error triggering AI call:",t)}}async function W(t,e){try{const{data:r,error:o}=await s.from("profiles").select("user_id").eq("user_id",t).single();if(o||!r){console.error("Profile not found for user_id:",t,o);return}const a=Math.floor(e/1e3),{error:i}=await s.from("leaderboard_global").upsert({user_id:t,best_score:a,updated_at:new Date().toISOString()},{onConflict:"user_id"});i?console.error("Error updating leaderboard_global:",{message:i.message,details:i.details,hint:i.hint,code:i.code,userId:t,best_score:a}):console.log(`Updated leaderboard_global: ${a}s unproductive time (best_score) for user ${t}`)}catch(r){console.error("Error updating leaderboard_global:",r instanceof Error?r.message:String(r))}}async function h(){if(m||!_){await c(),await n({lastTick:Date.now()});return}const t=await c(),e=Date.now(),r=e-t.lastTick;if(r<=0){await n({lastTick:e});return}const o=await d(),a=l(o);if(a!==t.currentDomain){await f(a);const i=await c();await D(i,r)}else await D(t,r)}async function D(t,e){const r=v(t.currentDomain),o=t.userId;if(!o||!t.currentDomain){await n({lastTick:Date.now()});return}if(r==="productive"){const a=t.consecutiveProductiveMs+e,i=(t.totalProductiveMs||0)+e;a>=U&&a-e<U&&(console.log("Productive time reached 2 minutes, triggering AI agent call"),await B()),a>=M?(await P(t.currentDomain,a,o),await n({consecutiveProductiveMs:0,totalProductiveMs:i,lastTick:Date.now()})):await n({consecutiveProductiveMs:a,totalProductiveMs:i,lastTick:Date.now()})}else if(r==="unproductive"){const a=t.unproductiveMsBuffer+e,i=(t.totalUnproductiveMs||0)+e;a>=O?(await S(a,o),await n({unproductiveMsBuffer:0,totalUnproductiveMs:i,lastTick:Date.now()})):await n({unproductiveMsBuffer:a,totalUnproductiveMs:i,lastTick:Date.now()})}else await n({lastTick:Date.now()})}async function I(){const t=await c(),e=Date.now();if(!t.userId)return;e-(t.lastLeaderboardUpdate||0)>=b&&(await W(t.userId,t.totalUnproductiveMs||0),await n({lastLeaderboardUpdate:e}))}async function $(){const{data:{session:t}}=await s.auth.getSession();if(t!=null&&t.user){const o=await E(t.user.id);o?(await p(o),console.log("Restored session for user:",t.user.email)):console.warn("Profile not found for auth user, cannot set userId")}const e=await d(),r=l(e);await f(r),setInterval(()=>{h().catch(console.error)},R),setInterval(()=>{I().catch(console.error)},b),h().catch(console.error),I().catch(console.error)}chrome.tabs.onActivated.addListener(async()=>{const t=await d(),e=l(t);await f(e)});chrome.tabs.onUpdated.addListener(async(t,e,r)=>{if(e.status==="complete"&&r.url){const o=l(r.url);await c(),await d()===r.url&&await f(o)}});chrome.windows.onFocusChanged.addListener(async t=>{if(t===chrome.windows.WINDOW_ID_NONE)_=!1;else{_=!0;const e=await d(),r=l(e);await f(r)}});chrome.idle.onStateChanged.addListener(t=>{m=t==="idle"||t==="locked",console.log(m?"User is idle/locked, pausing tracking":"User is active, resuming tracking")});s.auth.onAuthStateChange(async(t,e)=>{if(t==="SIGNED_IN"&&(e!=null&&e.user)){const r=await E(e.user.id);r?(await p(r),console.log("User signed in:",e.user.email)):console.warn("Profile not found for auth user, cannot set userId")}else t==="SIGNED_OUT"&&(await p(null),await n({currentDomain:null,consecutiveProductiveMs:0,unproductiveMsBuffer:0,totalProductiveMs:0,totalUnproductiveMs:0,lastLeaderboardUpdate:0,lastCallTriggerTime:0}),console.log("User signed out"))});$().catch(console.error);
