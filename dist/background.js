import{e as h,s as d,a as U,u as a,g as v,c as D,T as g,b as I,d as b,W as w}from"./assets/supabaseClient-BGmU8szT.js";const M=6e4,R=1e4,$=1e3,S=6e4,p=12e4;let k=!1,P=!0;async function A(e){try{const{data:o,error:r}=await d.from("profiles").select("user_id").eq("user_id",e).single();return r?(console.error("Error getting profile user_id:",r),null):(o==null?void 0:o.user_id)||null}catch(o){return console.error("Error getting profile user_id:",o),null}}async function m(){try{const e=await chrome.windows.getAll({populate:!0});for(const r of e)if(r.focused&&r.tabs){for(const t of r.tabs)if(t.active&&t.url)return t.url}const o=await chrome.tabs.query({active:!0});return o.length>0&&o[0].url?o[0].url:null}catch{return null}}async function T(e){const o=await v();if(o.currentDomain===e)return;const r=D(o.currentDomain),t=D(e);o.currentDomain&&o.userId&&(r==="productive"&&o.consecutiveProductiveMs>=M?await L(o.currentDomain,o.consecutiveProductiveMs,o.userId):r==="unproductive"&&o.unproductiveMsBuffer>=R&&await N(o.unproductiveMsBuffer,o.userId));const n=r==="productive"&&t==="unproductive",s=r==="unproductive"&&t==="productive";await a({currentDomain:e,lastTick:Date.now(),consecutiveProductiveMs:n?0:o.consecutiveProductiveMs,unproductiveMsBuffer:s?0:o.unproductiveMsBuffer}),n?console.log("ðŸ”„ Switched from productive to unproductive domain, reset productive counter"):s?console.log("ðŸ”„ Switched from unproductive to productive domain, reset unproductive buffer"):r==="productive"&&t==="productive"&&console.log("âœ… Switched between productive domains, keeping productive counter running")}async function L(e,o,r){try{const t=Math.floor(o/1e3);await d.from("productive_triggers").insert({user_id:r,domain:e,duration_seconds:t}),console.log(`Recorded productive trigger: ${e} for ${t}s`)}catch(t){console.error("Error recording productive trigger:",t)}}async function N(e,o){try{const r=Math.floor(e/1e3);await d.from("leaderboard_scores").insert({user_id:o,score:r}),console.log(`Recorded unproductive time: ${r}s`)}catch(r){console.error("Error recording unproductive time:",r)}}async function B(){try{if(console.log("ðŸ“ž triggerAICall() called - starting call initiation process (using test call logic)..."),!w||w.includes("your-webhook-server.com")){console.error("âŒ Webhook URL not configured. Please set VITE_WEBHOOK_URL in .env file.");return}const e=await v();if(!e.userId){console.error("âŒ No user ID found. Cannot initiate call.");return}console.log("âœ… User ID found:",e.userId);const{data:o,error:r}=await d.from("profiles").select("dads_number").eq("user_id",e.userId).single();if(r||!o){console.error("âŒ Error fetching profile:",r);return}const t=o.dads_number;if(!t||!t.trim()){console.error("âŒ Dad's number not found in profile. Cannot initiate call.");return}console.log("âœ… Dad's number found:",t);const n=t.trim().replace(/[\s\-\(\)]/g,""),s=n.startsWith("+")?n:n.startsWith("1")&&n.length===11?`+${n}`:`+1${n}`;console.log("ðŸ“ž Calling dad's number:",s,"(original:",t,")");const f=btoa(`${g}:${I}`),u=`https://api.twilio.com/2010-04-01/Accounts/${g}/Calls.json`,i=new URLSearchParams;i.append("From",b),i.append("To",s),i.append("Url",w),i.append("Method","POST"),console.log("ðŸ“ž Initiating automatic call (same as test button)...",{from:b,to:s,webhook:w}),console.log("Twilio API Request:",{url:u,accountSid:g?`${g.substring(0,10)}...`:"MISSING",authToken:I?`${I.substring(0,10)}...`:"MISSING",from:b,to:s,webhook:w});const l=await fetch(u,{method:"POST",headers:{Authorization:`Basic ${f}`,"Content-Type":"application/x-www-form-urlencoded"},body:i.toString()});if(!l.ok){const c=await l.text();console.error("Twilio API Error:",{status:l.status,statusText:l.statusText,error:c.substring(0,500)}),l.status===401||l.status===403?console.error("Twilio authentication failed. Please check your Twilio credentials in the .env file and rebuild the extension."):(c.includes("html")||c.includes("login"))&&console.error("Twilio authentication failed. The credentials may be incorrect. Please verify your Twilio Account SID and Auth Token.");return}const _=await l.json();console.log("âœ…âœ…âœ… AI agent call successfully initiated! âœ…âœ…âœ…"),console.log("   Call SID:",_.sid),console.log("   Calling:",s),console.log("   This is the same logic as the test button - call should work!");const E=Date.now();await a({lastCallTriggerTime:E,consecutiveProductiveMs:0,totalProductiveMs:0}),console.log("âœ… Productive time reset to 0"),console.log("âœ… Counter will start accumulating again for the next cycle")}catch(e){console.error("âŒâŒâŒ ERROR TRIGGERING AI CALL âŒâŒâŒ"),console.error("   Error:",e),e instanceof Error&&(console.error("   Error message:",e.message),console.error("   Error stack:",e.stack))}}async function W(e,o){try{const{data:r,error:t}=await d.from("profiles").select("user_id").eq("user_id",e).single();if(t||!r){console.error("Profile not found for user_id:",e,t);return}const n=Math.floor(o/1e3),{error:s}=await d.from("leaderboard_global").upsert({user_id:e,best_score:n,updated_at:new Date().toISOString()},{onConflict:"user_id"});s?console.error("Error updating leaderboard_global:",{message:s.message,details:s.details,hint:s.hint,code:s.code,userId:e,best_score:n}):console.log(`Updated leaderboard_global: ${n}s unproductive time (best_score) for user ${e}`)}catch(r){console.error("Error updating leaderboard_global:",r instanceof Error?r.message:String(r))}}async function y(){const e=await v(),o=Date.now(),r=o-e.lastTick,t=1e4,n=r>t?t:r;if(n<=0){await a({lastTick:o});return}if(r>t&&console.log(`âš ï¸ Service worker was suspended for ${Math.floor(r/1e3)}s, continuing tracking with capped elapsed time`),k&&!P){console.log("â¸ï¸ Pausing tracking: user is idle and window is not focused"),await a({lastTick:o});return}const f=await m(),u=h(f??void 0);if(u!==e.currentDomain){await T(u);const i=await v();await C(i,n)}else await C(e,n)}async function C(e,o){const r=D(e.currentDomain),t=e.userId;if(!t||!e.currentDomain){await a({lastTick:Date.now()});return}if(r==="productive"){const n=e.consecutiveProductiveMs+o,s=(e.totalProductiveMs||0)+o,f=e.consecutiveProductiveMs,u=Math.floor(f/1e3),i=Math.floor(n/1e3),l=n>=p,_=f<p;if(i>0&&i%10===0&&u<i&&console.log(`â±ï¸ Productive time: ${i}s / 120s (${Math.floor(n/p*100)}%)`),l&&_){const E=Math.floor(n/1e3);console.log(`ðŸš€ðŸš€ðŸš€ PRODUCTIVE TIME REACHED ${E} SECONDS (2 MINUTES) ðŸš€ðŸš€ðŸš€`),console.log(`   Previous: ${u}s, New: ${i}s`),console.log(`   Threshold: ${p}ms (${p/1e3}s)`),console.log("   Triggering AI agent call NOW...");try{await B(),console.log("âœ… triggerAICall() completed")}catch(c){console.error("âŒ ERROR in triggerAICall():",c),console.error("   Error details:",c instanceof Error?c.message:String(c)),console.error("   Error stack:",c instanceof Error?c.stack:"No stack trace")}}n>=M&&f<M&&await L(e.currentDomain,n,t),await a({consecutiveProductiveMs:n,totalProductiveMs:s,lastTick:Date.now()})}else if(r==="unproductive"){const n=e.unproductiveMsBuffer+o,s=(e.totalUnproductiveMs||0)+o;n>=R?(await N(n,t),await a({unproductiveMsBuffer:0,totalUnproductiveMs:s,lastTick:Date.now()})):await a({unproductiveMsBuffer:n,totalUnproductiveMs:s,lastTick:Date.now()})}else await a({lastTick:Date.now()})}async function O(){const e=await v(),o=Date.now();if(!e.userId)return;o-(e.lastLeaderboardUpdate||0)>=S&&(await W(e.userId,e.totalUnproductiveMs||0),await a({lastLeaderboardUpdate:o}))}async function G(){const{data:{session:e}}=await d.auth.getSession();if(e!=null&&e.user){const t=await A(e.user.id);t?(await U(t),console.log("Restored session for user:",e.user.email)):console.warn("Profile not found for auth user, cannot set userId")}const o=await m(),r=h(o??void 0);await T(r),setInterval(()=>{y().catch(t=>{console.error("Error in tick:",t)})},$),chrome.alarms.create("leaderboardUpdate",{periodInMinutes:S/6e4,delayInMinutes:S/6e4}),y().catch(console.error),O().catch(console.error),console.log("âœ… Tracking initialized"),console.log("   - Counter will continue even when window loses focus"),console.log("   - Counter only pauses if user is idle AND window is not focused"),console.log("   - Service worker suspension is handled automatically")}chrome.alarms.onAlarm.addListener(e=>{e.name==="leaderboardUpdate"&&O().catch(console.error)});chrome.tabs.onActivated.addListener(async()=>{const e=await m(),o=h(e??void 0);await T(o)});chrome.tabs.onUpdated.addListener(async(e,o,r)=>{if(o.status==="complete"&&r.url){const t=h(r.url);await m()===r.url&&await T(t)}});chrome.windows.onFocusChanged.addListener(async e=>{if(e===chrome.windows.WINDOW_ID_NONE)P=!1,console.log("âš ï¸ Window lost focus, but tracking continues (counter will NOT stop)");else{P=!0,console.log("âœ… Window gained focus, tracking active");const o=await m(),r=h(o??void 0);await T(r)}});chrome.idle.onStateChanged.addListener(e=>{k=e==="idle"||e==="locked",console.log(k?"âš ï¸ User is idle/locked, but tracking continues (counter will only pause if window is also not focused)":"âœ… User is active, tracking continues")});d.auth.onAuthStateChange(async(e,o)=>{if(e==="SIGNED_IN"&&(o!=null&&o.user)){const r=await A(o.user.id);r?(await U(r),console.log("User signed in:",o.user.email)):console.warn("Profile not found for auth user, cannot set userId")}else e==="SIGNED_OUT"&&(await U(null),await a({currentDomain:null,consecutiveProductiveMs:0,unproductiveMsBuffer:0,totalProductiveMs:0,totalUnproductiveMs:0,lastLeaderboardUpdate:0,lastCallTriggerTime:0}),console.log("User signed out"))});G().catch(console.error);
