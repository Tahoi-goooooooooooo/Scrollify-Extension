import{e as f,s,a as _,u as n,g as d,c as I,T as l,b as p,d as h,W as v}from"./assets/supabaseClient-BGmU8szT.js";const y=6e4,N=1e4,B=1e3,k=6e4,M=12e4,W=3e5;let D=!1,U=!0;async function A(e){try{const{data:r,error:t}=await s.from("profiles").select("user_id").eq("user_id",e).single();return t?(console.error("Error getting profile user_id:",t),null):(r==null?void 0:r.user_id)||null}catch(r){return console.error("Error getting profile user_id:",r),null}}async function w(){try{const e=await chrome.windows.getAll({populate:!0});for(const t of e)if(t.focused&&t.tabs){for(const o of t.tabs)if(o.active&&o.url)return o.url}const r=await chrome.tabs.query({active:!0});return r.length>0&&r[0].url?r[0].url:null}catch{return null}}async function g(e){const r=await d();if(r.currentDomain===e)return;if(r.currentDomain&&r.userId){const o=I(r.currentDomain);o==="productive"&&r.consecutiveProductiveMs>0?r.consecutiveProductiveMs>=y&&await L(r.currentDomain,r.consecutiveProductiveMs,r.userId):o==="unproductive"&&r.unproductiveMsBuffer>0&&await C(r.unproductiveMsBuffer,r.userId)}const t=I(e);await n({currentDomain:e,lastTick:Date.now(),consecutiveProductiveMs:t==="productive"?0:r.consecutiveProductiveMs,unproductiveMsBuffer:t==="unproductive"?0:r.unproductiveMsBuffer})}async function L(e,r,t){try{const o=Math.floor(r/1e3);await s.from("productive_triggers").insert({user_id:t,domain:e,duration_seconds:o}),console.log(`Recorded productive trigger: ${e} for ${o}s`)}catch(o){console.error("Error recording productive trigger:",o)}}async function C(e,r){try{const t=Math.floor(e/1e3);await s.from("leaderboard_scores").insert({user_id:r,score:t}),console.log(`Recorded unproductive time: ${t}s`)}catch(t){console.error("Error recording unproductive time:",t)}}async function $(){try{const e=await d(),r=Date.now();if(e.lastCallTriggerTime>0&&r-e.lastCallTriggerTime<W){console.log("AI call cooldown active, skipping call");return}if(!e.userId){console.error("No user ID found. Cannot initiate call.");return}const{data:t,error:o}=await s.from("profiles").select("dads_number").eq("user_id",e.userId).single();if(o||!t){console.error("Error fetching profile:",o);return}const i=t.dads_number;if(!i||!i.trim()){console.error("Dad's number not found in profile. Cannot initiate call.");return}const a=i.trim().replace(/[\s\-\(\)]/g,""),m=a.startsWith("+")?a:a.startsWith("1")&&a.length===11?`+${a}`:`+1${a}`;if(console.log("Calling dad's number:",m,"(original:",i,")"),!v||v.includes("your-webhook-server.com")){console.error("Webhook URL not configured. Please set VITE_WEBHOOK_URL in .env file.");return}const O=btoa(`${l}:${p}`),b=`https://api.twilio.com/2010-04-01/Accounts/${l}/Calls.json`,u=new URLSearchParams;u.append("From",h),u.append("To",m),u.append("Url",v),u.append("Method","POST"),console.log("Twilio API Request:",{url:b,accountSid:l?`${l.substring(0,10)}...`:"MISSING",authToken:p?`${p.substring(0,10)}...`:"MISSING",from:h,to:m,webhook:v});const c=await fetch(b,{method:"POST",headers:{Authorization:`Basic ${O}`,"Content-Type":"application/x-www-form-urlencoded"},body:u.toString()});if(!c.ok){const T=await c.text();console.error("Twilio API Error:",{status:c.status,statusText:c.statusText,error:T.substring(0,500)}),c.status===401||c.status===403?console.error("Twilio authentication failed. Please check your Twilio credentials in the .env file and rebuild the extension."):(T.includes("html")||T.includes("login"))&&console.error("Twilio authentication failed. The credentials may be incorrect. Please verify your Twilio Account SID and Auth Token.");return}const R=await c.json();console.log("AI agent call initiated:",R.sid),await n({lastCallTriggerTime:r})}catch(e){console.error("Error triggering AI call:",e)}}async function G(e,r){try{const{data:t,error:o}=await s.from("profiles").select("user_id").eq("user_id",e).single();if(o||!t){console.error("Profile not found for user_id:",e,o);return}const i=Math.floor(r/1e3),{error:a}=await s.from("leaderboard_global").upsert({user_id:e,best_score:i,updated_at:new Date().toISOString()},{onConflict:"user_id"});a?console.error("Error updating leaderboard_global:",{message:a.message,details:a.details,hint:a.hint,code:a.code,userId:e,best_score:i}):console.log(`Updated leaderboard_global: ${i}s unproductive time (best_score) for user ${e}`)}catch(t){console.error("Error updating leaderboard_global:",t instanceof Error?t.message:String(t))}}async function P(){if(D||!U){await n({lastTick:Date.now()});return}const e=await d(),r=Date.now(),t=r-e.lastTick;if(t<=0){await n({lastTick:r});return}const o=await w(),i=f(o??void 0);if(i!==e.currentDomain){await g(i);const a=await d();await E(a,t)}else await E(e,t)}async function E(e,r){const t=I(e.currentDomain),o=e.userId;if(!o||!e.currentDomain){await n({lastTick:Date.now()});return}if(t==="productive"){const i=e.consecutiveProductiveMs+r,a=(e.totalProductiveMs||0)+r;i>=M&&i-r<M&&(console.log("Productive time reached 2 minutes, triggering AI agent call"),await $()),i>=y?(await L(e.currentDomain,i,o),await n({consecutiveProductiveMs:0,totalProductiveMs:a,lastTick:Date.now()})):await n({consecutiveProductiveMs:i,totalProductiveMs:a,lastTick:Date.now()})}else if(t==="unproductive"){const i=e.unproductiveMsBuffer+r,a=(e.totalUnproductiveMs||0)+r;i>=N?(await C(i,o),await n({unproductiveMsBuffer:0,totalUnproductiveMs:a,lastTick:Date.now()})):await n({unproductiveMsBuffer:i,totalUnproductiveMs:a,lastTick:Date.now()})}else await n({lastTick:Date.now()})}async function S(){const e=await d(),r=Date.now();if(!e.userId)return;r-(e.lastLeaderboardUpdate||0)>=k&&(await G(e.userId,e.totalUnproductiveMs||0),await n({lastLeaderboardUpdate:r}))}async function x(){const{data:{session:e}}=await s.auth.getSession();if(e!=null&&e.user){const o=await A(e.user.id);o?(await _(o),console.log("Restored session for user:",e.user.email)):console.warn("Profile not found for auth user, cannot set userId")}const r=await w(),t=f(r??void 0);await g(t),setInterval(()=>{P().catch(console.error)},B),setInterval(()=>{S().catch(console.error)},k),P().catch(console.error),S().catch(console.error)}chrome.tabs.onActivated.addListener(async()=>{const e=await w(),r=f(e??void 0);await g(r)});chrome.tabs.onUpdated.addListener(async(e,r,t)=>{if(r.status==="complete"&&t.url){const o=f(t.url);await w()===t.url&&await g(o)}});chrome.windows.onFocusChanged.addListener(async e=>{if(e===chrome.windows.WINDOW_ID_NONE)U=!1;else{U=!0;const r=await w(),t=f(r??void 0);await g(t)}});chrome.idle.onStateChanged.addListener(e=>{D=e==="idle"||e==="locked",console.log(D?"User is idle/locked, pausing tracking":"User is active, resuming tracking")});s.auth.onAuthStateChange(async(e,r)=>{if(e==="SIGNED_IN"&&(r!=null&&r.user)){const t=await A(r.user.id);t?(await _(t),console.log("User signed in:",r.user.email)):console.warn("Profile not found for auth user, cannot set userId")}else e==="SIGNED_OUT"&&(await _(null),await n({currentDomain:null,consecutiveProductiveMs:0,unproductiveMsBuffer:0,totalProductiveMs:0,totalUnproductiveMs:0,lastLeaderboardUpdate:0,lastCallTriggerTime:0}),console.log("User signed out"))});x().catch(console.error);
