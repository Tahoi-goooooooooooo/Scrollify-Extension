import{e as h,s as d,a as U,u as c,g as m,c as b,T as p,b as S,d as _,W as w}from"./assets/supabaseClient-BGmU8szT.js";const M=6e4,A=1e4,W=1e3,C=6e4,v=12e4,D=3e5;let P=!1,k=!0;async function L(e){try{const{data:o,error:r}=await d.from("profiles").select("user_id").eq("user_id",e).single();return r?(console.error("Error getting profile user_id:",r),null):(o==null?void 0:o.user_id)||null}catch(o){return console.error("Error getting profile user_id:",o),null}}async function T(){try{const e=await chrome.windows.getAll({populate:!0});for(const r of e)if(r.focused&&r.tabs){for(const t of r.tabs)if(t.active&&t.url)return t.url}const o=await chrome.tabs.query({active:!0});return o.length>0&&o[0].url?o[0].url:null}catch{return null}}async function I(e){const o=await m();if(o.currentDomain===e)return;const r=b(o.currentDomain),t=b(e);o.currentDomain&&o.userId&&(r==="productive"&&o.consecutiveProductiveMs>=M?await O(o.currentDomain,o.consecutiveProductiveMs,o.userId):r==="unproductive"&&o.unproductiveMsBuffer>=A&&await N(o.unproductiveMsBuffer,o.userId));const n=r==="productive"&&t==="unproductive",s=r==="unproductive"&&t==="productive";await c({currentDomain:e,lastTick:Date.now(),consecutiveProductiveMs:n?0:o.consecutiveProductiveMs,unproductiveMsBuffer:s?0:o.unproductiveMsBuffer}),n?console.log("ðŸ”„ Switched from productive to unproductive domain, reset productive counter"):s?console.log("ðŸ”„ Switched from unproductive to productive domain, reset unproductive buffer"):r==="productive"&&t==="productive"&&console.log("âœ… Switched between productive domains, keeping productive counter running")}async function O(e,o,r){try{const t=Math.floor(o/1e3);await d.from("productive_triggers").insert({user_id:r,domain:e,duration_seconds:t}),console.log(`Recorded productive trigger: ${e} for ${t}s`)}catch(t){console.error("Error recording productive trigger:",t)}}async function N(e,o){try{const r=Math.floor(e/1e3);await d.from("leaderboard_scores").insert({user_id:o,score:r}),console.log(`Recorded unproductive time: ${r}s`)}catch(r){console.error("Error recording unproductive time:",r)}}async function B(){try{console.log("ðŸ“ž triggerAICall() called - starting call initiation process...");const e=await m(),o=Date.now();if(e.lastCallTriggerTime>0&&o-e.lastCallTriggerTime<D){const i=Math.ceil((D-(o-e.lastCallTriggerTime))/1e3);console.log(`â¸ï¸ AI call cooldown active (${i}s remaining), skipping call`),console.log(`   Last call time: ${new Date(e.lastCallTriggerTime).toISOString()}`),console.log(`   Current time: ${new Date(o).toISOString()}`),console.log(`   Cooldown period: ${D/1e3}s`);return}if(console.log("âœ… Cooldown check passed, proceeding with call..."),!e.userId){console.error("âŒ No user ID found. Cannot initiate call."),console.error("   State:",JSON.stringify(e,null,2));return}console.log("âœ… User ID found:",e.userId);const{data:r,error:t}=await d.from("profiles").select("dads_number").eq("user_id",e.userId).single();if(t||!r){console.error("âŒ Error fetching profile:",t),console.error("   Profile data:",r);return}console.log("âœ… Profile fetched successfully");const n=r.dads_number;if(!n||!n.trim()){console.error("âŒ Dad's number not found in profile. Cannot initiate call."),console.error("   Profile:",JSON.stringify(r,null,2));return}console.log("âœ… Dad's number found:",n);const s=n.trim().replace(/[\s\-\(\)]/g,""),a=s.startsWith("+")?s:s.startsWith("1")&&s.length===11?`+${s}`:`+1${s}`;if(console.log("Calling dad's number:",a,"(original:",n,")"),console.log("âœ… Twilio credentials validated"),!w||w.includes("your-webhook-server.com")){console.error("âŒ Webhook URL not configured. Please set VITE_WEBHOOK_URL in .env file."),console.error("   WEBHOOK_URL:",w);return}console.log("âœ… Webhook URL validated:",w);const f=btoa(`${p}:${S}`),l=`https://api.twilio.com/2010-04-01/Accounts/${p}/Calls.json`,g=new URLSearchParams;g.append("From",_),g.append("To",a),g.append("Url",w),g.append("Method","POST"),console.log("Twilio API Request:",{url:l,accountSid:p?`${p.substring(0,10)}...`:"MISSING",authToken:S?`${S.substring(0,10)}...`:"MISSING",from:_,to:a,webhook:w});const u=await fetch(l,{method:"POST",headers:{Authorization:`Basic ${f}`,"Content-Type":"application/x-www-form-urlencoded"},body:g.toString()});if(!u.ok){const i=await u.text();console.error("Twilio API Error:",{status:u.status,statusText:u.statusText,error:i.substring(0,500)}),u.status===401||u.status===403?console.error("Twilio authentication failed. Please check your Twilio credentials in the .env file and rebuild the extension."):(i.includes("html")||i.includes("login"))&&console.error("Twilio authentication failed. The credentials may be incorrect. Please verify your Twilio Account SID and Auth Token.");return}const E=await u.json();console.log("âœ… AI agent call successfully initiated!"),console.log("   Call SID:",E.sid),console.log("   To:",a),await c({lastCallTriggerTime:o,consecutiveProductiveMs:0,totalProductiveMs:0}),console.log("âœ…âœ…âœ… CALL SUCCESSFULLY INITIATED AND PRODUCTIVE TIME RESET âœ…âœ…âœ…"),console.log("   Call SID:",E.sid),console.log("   To:",a),console.log("   Productive time reset to 0"),console.log("   Counter will start accumulating again for the next cycle")}catch(e){console.error("âŒâŒâŒ ERROR TRIGGERING AI CALL âŒâŒâŒ"),console.error("   Error:",e),e instanceof Error&&(console.error("   Error message:",e.message),console.error("   Error stack:",e.stack))}}async function G(e,o){try{const{data:r,error:t}=await d.from("profiles").select("user_id").eq("user_id",e).single();if(t||!r){console.error("Profile not found for user_id:",e,t);return}const n=Math.floor(o/1e3),{error:s}=await d.from("leaderboard_global").upsert({user_id:e,best_score:n,updated_at:new Date().toISOString()},{onConflict:"user_id"});s?console.error("Error updating leaderboard_global:",{message:s.message,details:s.details,hint:s.hint,code:s.code,userId:e,best_score:n}):console.log(`Updated leaderboard_global: ${n}s unproductive time (best_score) for user ${e}`)}catch(r){console.error("Error updating leaderboard_global:",r instanceof Error?r.message:String(r))}}async function y(){const e=await m(),o=Date.now(),r=o-e.lastTick,t=1e4,n=r>t?t:r;if(n<=0){await c({lastTick:o});return}if(r>t&&console.log(`âš ï¸ Service worker was suspended for ${Math.floor(r/1e3)}s, continuing tracking with capped elapsed time`),P&&!k){console.log("â¸ï¸ Pausing tracking: user is idle and window is not focused"),await c({lastTick:o});return}const a=await T(),f=h(a??void 0);if(f!==e.currentDomain){await I(f);const l=await m();await R(l,n)}else await R(e,n)}async function R(e,o){const r=b(e.currentDomain),t=e.userId;if(!t||!e.currentDomain){await c({lastTick:Date.now()});return}if(r==="productive"){const n=e.consecutiveProductiveMs+o,s=(e.totalProductiveMs||0)+o,a=e.consecutiveProductiveMs,f=Math.floor(a/1e3),l=Math.floor(n/1e3),g=n>=v,u=a<v;if(l>0&&l%10===0&&f<l&&console.log(`â±ï¸ Productive time: ${l}s / 120s (${Math.floor(n/v*100)}%)`),g&&u){const E=Math.floor(n/1e3);console.log(`ðŸš€ðŸš€ðŸš€ PRODUCTIVE TIME REACHED ${E} SECONDS (2 MINUTES) ðŸš€ðŸš€ðŸš€`),console.log(`   Previous: ${f}s, New: ${l}s`),console.log(`   Threshold: ${v}ms (${v/1e3}s)`),console.log("   Triggering AI agent call NOW...");try{await B(),console.log("âœ… triggerAICall() completed")}catch(i){console.error("âŒ ERROR in triggerAICall():",i),console.error("   Error details:",i instanceof Error?i.message:String(i)),console.error("   Error stack:",i instanceof Error?i.stack:"No stack trace")}}n>=M&&a<M&&await O(e.currentDomain,n,t),await c({consecutiveProductiveMs:n,totalProductiveMs:s,lastTick:Date.now()})}else if(r==="unproductive"){const n=e.unproductiveMsBuffer+o,s=(e.totalUnproductiveMs||0)+o;n>=A?(await N(n,t),await c({unproductiveMsBuffer:0,totalUnproductiveMs:s,lastTick:Date.now()})):await c({unproductiveMsBuffer:n,totalUnproductiveMs:s,lastTick:Date.now()})}else await c({lastTick:Date.now()})}async function $(){const e=await m(),o=Date.now();if(!e.userId)return;o-(e.lastLeaderboardUpdate||0)>=C&&(await G(e.userId,e.totalUnproductiveMs||0),await c({lastLeaderboardUpdate:o}))}async function x(){const{data:{session:e}}=await d.auth.getSession();if(e!=null&&e.user){const t=await L(e.user.id);t?(await U(t),console.log("Restored session for user:",e.user.email)):console.warn("Profile not found for auth user, cannot set userId")}const o=await T(),r=h(o??void 0);await I(r),setInterval(()=>{y().catch(t=>{console.error("Error in tick:",t)})},W),chrome.alarms.create("leaderboardUpdate",{periodInMinutes:C/6e4,delayInMinutes:C/6e4}),y().catch(console.error),$().catch(console.error),console.log("âœ… Tracking initialized"),console.log("   - Counter will continue even when window loses focus"),console.log("   - Counter only pauses if user is idle AND window is not focused"),console.log("   - Service worker suspension is handled automatically")}chrome.alarms.onAlarm.addListener(e=>{e.name==="leaderboardUpdate"&&$().catch(console.error)});chrome.tabs.onActivated.addListener(async()=>{const e=await T(),o=h(e??void 0);await I(o)});chrome.tabs.onUpdated.addListener(async(e,o,r)=>{if(o.status==="complete"&&r.url){const t=h(r.url);await T()===r.url&&await I(t)}});chrome.windows.onFocusChanged.addListener(async e=>{if(e===chrome.windows.WINDOW_ID_NONE)k=!1,console.log("âš ï¸ Window lost focus, but tracking continues (counter will NOT stop)");else{k=!0,console.log("âœ… Window gained focus, tracking active");const o=await T(),r=h(o??void 0);await I(r)}});chrome.idle.onStateChanged.addListener(e=>{P=e==="idle"||e==="locked",console.log(P?"âš ï¸ User is idle/locked, but tracking continues (counter will only pause if window is also not focused)":"âœ… User is active, tracking continues")});d.auth.onAuthStateChange(async(e,o)=>{if(e==="SIGNED_IN"&&(o!=null&&o.user)){const r=await L(o.user.id);r?(await U(r),console.log("User signed in:",o.user.email)):console.warn("Profile not found for auth user, cannot set userId")}else e==="SIGNED_OUT"&&(await U(null),await c({currentDomain:null,consecutiveProductiveMs:0,unproductiveMsBuffer:0,totalProductiveMs:0,totalUnproductiveMs:0,lastLeaderboardUpdate:0,lastCallTriggerTime:0}),console.log("User signed out"))});x().catch(console.error);
