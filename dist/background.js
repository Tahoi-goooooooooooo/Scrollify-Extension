import{e as u,g as s,s as c,a as f,u as n,c as w}from"./assets/supabaseClient-4HcaMfFh.js";const _=6e4,b=1e4,I=1e3,U=6e4;let v=!1,p=!0;async function M(t){try{const{data:e,error:r}=await c.from("profiles").select("user_id").eq("user_id",t).single();return r?(console.error("Error getting profile user_id:",r),null):(e==null?void 0:e.user_id)||null}catch(e){return console.error("Error getting profile user_id:",e),null}}async function d(){try{const t=await chrome.windows.getAll({populate:!0});for(const r of t)if(r.focused&&r.tabs){for(const o of r.tabs)if(o.active&&o.url)return o.url}const e=await chrome.tabs.query({active:!0});return e.length>0&&e[0].url?e[0].url:null}catch{return null}}async function l(t){const e=await s();if(e.currentDomain===t)return;if(e.currentDomain&&e.userId){const o=w(e.currentDomain);o==="productive"&&e.consecutiveProductiveMs>0?e.consecutiveProductiveMs>=_&&await h(e.currentDomain,e.consecutiveProductiveMs,e.userId):o==="unproductive"&&e.unproductiveMsBuffer>0&&await T(e.unproductiveMsBuffer,e.userId)}const r=w(t);await n({currentDomain:t,lastTick:Date.now(),consecutiveProductiveMs:r==="productive"?0:e.consecutiveProductiveMs,unproductiveMsBuffer:r==="unproductive"?0:e.unproductiveMsBuffer})}async function h(t,e,r){try{const o=Math.floor(e/1e3);await c.from("productive_triggers").insert({user_id:r,domain:t,duration_seconds:o}),console.log(`Recorded productive trigger: ${t} for ${o}s`)}catch(o){console.error("Error recording productive trigger:",o)}}async function T(t,e){try{const r=Math.floor(t/1e3);await c.from("leaderboard_scores").insert({user_id:e,score:r}),console.log(`Recorded unproductive time: ${r}s`)}catch(r){console.error("Error recording unproductive time:",r)}}async function y(t,e){try{const{data:r,error:o}=await c.from("profiles").select("user_id").eq("user_id",t).single();if(o||!r){console.error("Profile not found for user_id:",t,o);return}const a=Math.floor(e/1e3),{error:i}=await c.from("leaderboard_global").upsert({user_id:t,best_score:a,updated_at:new Date().toISOString()},{onConflict:"user_id"});i?console.error("Error updating leaderboard_global:",{message:i.message,details:i.details,hint:i.hint,code:i.code,userId:t,best_score:a}):console.log(`Updated leaderboard_global: ${a}s unproductive time (best_score) for user ${t}`)}catch(r){console.error("Error updating leaderboard_global:",r instanceof Error?r.message:String(r))}}async function g(){if(v||!p){await s(),await n({lastTick:Date.now()});return}const t=await s(),e=Date.now(),r=e-t.lastTick;if(r<=0){await n({lastTick:e});return}const o=await d(),a=u(o);if(a!==t.currentDomain){await l(a);const i=await s();await m(i,r)}else await m(t,r)}async function m(t,e){const r=w(t.currentDomain),o=t.userId;if(!o||!t.currentDomain){await n({lastTick:Date.now()});return}if(r==="productive"){const a=t.consecutiveProductiveMs+e,i=(t.totalProductiveMs||0)+e;a>=_?(await h(t.currentDomain,a,o),await n({consecutiveProductiveMs:0,totalProductiveMs:i,lastTick:Date.now()})):await n({consecutiveProductiveMs:a,totalProductiveMs:i,lastTick:Date.now()})}else if(r==="unproductive"){const a=t.unproductiveMsBuffer+e,i=(t.totalUnproductiveMs||0)+e;a>=b?(await T(a,o),await n({unproductiveMsBuffer:0,totalUnproductiveMs:i,lastTick:Date.now()})):await n({unproductiveMsBuffer:a,totalUnproductiveMs:i,lastTick:Date.now()})}else await n({lastTick:Date.now()})}async function D(){const t=await s(),e=Date.now();if(!t.userId)return;e-(t.lastLeaderboardUpdate||0)>=U&&(await y(t.userId,t.totalUnproductiveMs||0),await n({lastLeaderboardUpdate:e}))}async function P(){const{data:{session:t}}=await c.auth.getSession();if(t!=null&&t.user){const o=await M(t.user.id);o?(await f(o),console.log("Restored session for user:",t.user.email)):console.warn("Profile not found for auth user, cannot set userId")}const e=await d(),r=u(e);await l(r),setInterval(()=>{g().catch(console.error)},I),setInterval(()=>{D().catch(console.error)},U),g().catch(console.error),D().catch(console.error)}chrome.tabs.onActivated.addListener(async()=>{const t=await d(),e=u(t);await l(e)});chrome.tabs.onUpdated.addListener(async(t,e,r)=>{if(e.status==="complete"&&r.url){const o=u(r.url);await s(),await d()===r.url&&await l(o)}});chrome.windows.onFocusChanged.addListener(async t=>{if(t===chrome.windows.WINDOW_ID_NONE)p=!1;else{p=!0;const e=await d(),r=u(e);await l(r)}});chrome.idle.onStateChanged.addListener(t=>{v=t==="idle"||t==="locked",console.log(v?"User is idle/locked, pausing tracking":"User is active, resuming tracking")});c.auth.onAuthStateChange(async(t,e)=>{if(t==="SIGNED_IN"&&(e!=null&&e.user)){const r=await M(e.user.id);r?(await f(r),console.log("User signed in:",e.user.email)):console.warn("Profile not found for auth user, cannot set userId")}else t==="SIGNED_OUT"&&(await f(null),await n({currentDomain:null,consecutiveProductiveMs:0,unproductiveMsBuffer:0,totalProductiveMs:0,totalUnproductiveMs:0,lastLeaderboardUpdate:0}),console.log("User signed out"))});P().catch(console.error);
