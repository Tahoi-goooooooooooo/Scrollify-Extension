import{e as s,g as n,s as l,a as f,u as c,c as w}from"./assets/supabaseClient-BUvMfTvQ.js";const D=6e4,U=1e4,h=5e3;let v=!1,g=!0;async function u(){try{const e=await chrome.windows.getAll({populate:!0});for(const r of e)if(r.focused&&r.tabs){for(const o of r.tabs)if(o.active&&o.url)return o.url}const t=await chrome.tabs.query({active:!0});return t.length>0&&t[0].url?t[0].url:null}catch{return null}}async function d(e){const t=await n();if(t.currentDomain===e)return;if(t.currentDomain&&t.userId){const o=w(t.currentDomain);o==="productive"&&t.consecutiveProductiveMs>0?t.consecutiveProductiveMs>=D&&await M(t.currentDomain,t.consecutiveProductiveMs,t.userId):o==="unproductive"&&t.unproductiveMsBuffer>0&&await T(t.unproductiveMsBuffer,t.userId)}const r=w(e);await c({currentDomain:e,lastTick:Date.now(),consecutiveProductiveMs:r==="productive"?0:t.consecutiveProductiveMs,unproductiveMsBuffer:r==="unproductive"?0:t.unproductiveMsBuffer})}async function M(e,t,r){try{const o=Math.floor(t/1e3);await l.from("productive_triggers").insert({user_id:r,domain:e,duration_seconds:o}),console.log(`Recorded productive trigger: ${e} for ${o}s`)}catch(o){console.error("Error recording productive trigger:",o)}}async function T(e,t){try{const r=Math.floor(e/1e3);await l.from("leaderboard_scores").insert({user_id:t,score:r}),console.log(`Recorded unproductive time: ${r}s`)}catch(r){console.error("Error recording unproductive time:",r)}}async function m(){if(v||!g){await n(),await c({lastTick:Date.now()});return}const e=await n(),t=Date.now(),r=t-e.lastTick;if(r<=0){await c({lastTick:t});return}const o=await u(),i=s(o);if(i!==e.currentDomain){await d(i);const a=await n();await p(a,r)}else await p(e,r)}async function p(e,t){const r=w(e.currentDomain),o=e.userId;if(!o||!e.currentDomain){await c({lastTick:Date.now()});return}if(r==="productive"){const i=e.consecutiveProductiveMs+t,a=(e.totalProductiveMs||0)+t;i>=D?(await M(e.currentDomain,i,o),await c({consecutiveProductiveMs:0,totalProductiveMs:a,lastTick:Date.now()})):await c({consecutiveProductiveMs:i,totalProductiveMs:a,lastTick:Date.now()})}else if(r==="unproductive"){const i=e.unproductiveMsBuffer+t,a=(e.totalUnproductiveMs||0)+t;i>=U?(await T(i,o),await c({unproductiveMsBuffer:0,totalUnproductiveMs:a,lastTick:Date.now()})):await c({unproductiveMsBuffer:i,totalUnproductiveMs:a,lastTick:Date.now()})}else await c({lastTick:Date.now()})}async function I(){const{data:{session:e}}=await l.auth.getSession();e!=null&&e.user&&(await f(e.user.id),console.log("Restored session for user:",e.user.email));const t=await u(),r=s(t);await d(r),setInterval(()=>{m().catch(console.error)},h),m().catch(console.error)}chrome.tabs.onActivated.addListener(async()=>{const e=await u(),t=s(e);await d(t)});chrome.tabs.onUpdated.addListener(async(e,t,r)=>{if(t.status==="complete"&&r.url){const o=s(r.url);await n(),await u()===r.url&&await d(o)}});chrome.windows.onFocusChanged.addListener(async e=>{if(e===chrome.windows.WINDOW_ID_NONE)g=!1;else{g=!0;const t=await u(),r=s(t);await d(r)}});chrome.idle.onStateChanged.addListener(e=>{v=e==="idle"||e==="locked",console.log(v?"User is idle/locked, pausing tracking":"User is active, resuming tracking")});l.auth.onAuthStateChange(async(e,t)=>{e==="SIGNED_IN"&&(t!=null&&t.user)?(await f(t.user.id),console.log("User signed in:",t.user.email)):e==="SIGNED_OUT"&&(await f(null),await c({currentDomain:null,consecutiveProductiveMs:0,unproductiveMsBuffer:0,totalProductiveMs:0,totalUnproductiveMs:0}),console.log("User signed out"))});I().catch(console.error);
