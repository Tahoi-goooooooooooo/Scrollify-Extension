import{e as n,g as a,s as d,a as l,u as c,c as f}from"./assets/supabaseClient-BtN5acg_.js";const p=6e4,M=1e4,I=5e3;let w=!1,v=!0;async function s(){try{const t=await chrome.windows.getAll({populate:!0});for(const r of t)if(r.focused&&r.tabs){for(const i of r.tabs)if(i.active&&i.url)return i.url}const e=await chrome.tabs.query({active:!0});return e.length>0&&e[0].url?e[0].url:null}catch{return null}}async function u(t){const e=await a();if(e.currentDomain===t)return;if(e.currentDomain&&e.userId){const i=f(e.currentDomain);i==="productive"&&e.consecutiveProductiveMs>0?e.consecutiveProductiveMs>=p&&await D(e.currentDomain,e.consecutiveProductiveMs,e.userId):i==="unproductive"&&e.unproductiveMsBuffer>0&&await T(e.unproductiveMsBuffer,e.userId)}const r=f(t);await c({currentDomain:t,lastTick:Date.now(),consecutiveProductiveMs:r==="productive"?0:e.consecutiveProductiveMs,unproductiveMsBuffer:r==="unproductive"?0:e.unproductiveMsBuffer})}async function D(t,e,r){try{const i=Math.floor(e/1e3);await d.from("productive_triggers").insert({user_id:r,domain:t,duration_seconds:i}),console.log(`Recorded productive trigger: ${t} for ${i}s`)}catch(i){console.error("Error recording productive trigger:",i)}}async function T(t,e){try{const r=Math.floor(t/1e3);await d.from("leaderboard_scores").insert({user_id:e,score:r}),console.log(`Recorded unproductive time: ${r}s`)}catch(r){console.error("Error recording unproductive time:",r)}}async function g(){if(w||!v){await a(),await c({lastTick:Date.now()});return}const t=await a(),e=Date.now(),r=e-t.lastTick;if(r<=0){await c({lastTick:e});return}const i=await s(),o=n(i);if(o!==t.currentDomain){await u(o);const h=await a();await m(h,r)}else await m(t,r)}async function m(t,e){const r=f(t.currentDomain),i=t.userId;if(!i||!t.currentDomain){await c({lastTick:Date.now()});return}if(r==="productive"){const o=t.consecutiveProductiveMs+e;o>=p?(await D(t.currentDomain,o,i),await c({consecutiveProductiveMs:0,lastTick:Date.now()})):await c({consecutiveProductiveMs:o,lastTick:Date.now()})}else if(r==="unproductive"){const o=t.unproductiveMsBuffer+e;o>=M?(await T(o,i),await c({unproductiveMsBuffer:0,lastTick:Date.now()})):await c({unproductiveMsBuffer:o,lastTick:Date.now()})}else await c({lastTick:Date.now()})}async function U(){const{data:{session:t}}=await d.auth.getSession();t!=null&&t.user&&(await l(t.user.id),console.log("Restored session for user:",t.user.email));const e=await s(),r=n(e);await u(r),setInterval(()=>{g().catch(console.error)},I),g().catch(console.error)}chrome.tabs.onActivated.addListener(async()=>{const t=await s(),e=n(t);await u(e)});chrome.tabs.onUpdated.addListener(async(t,e,r)=>{if(e.status==="complete"&&r.url){const i=n(r.url);await a(),await s()===r.url&&await u(i)}});chrome.windows.onFocusChanged.addListener(async t=>{if(t===chrome.windows.WINDOW_ID_NONE)v=!1;else{v=!0;const e=await s(),r=n(e);await u(r)}});chrome.idle.onStateChanged.addListener(t=>{w=t==="idle"||t==="locked",console.log(w?"User is idle/locked, pausing tracking":"User is active, resuming tracking")});d.auth.onAuthStateChange(async(t,e)=>{t==="SIGNED_IN"&&(e!=null&&e.user)?(await l(e.user.id),console.log("User signed in:",e.user.email)):t==="SIGNED_OUT"&&(await l(null),await c({currentDomain:null,consecutiveProductiveMs:0,unproductiveMsBuffer:0}),console.log("User signed out"))});U().catch(console.error);
